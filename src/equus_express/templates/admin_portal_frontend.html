<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Admin Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e0e6ed 0%, #64b5f6 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .admin-panel {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #64b5f6, #64b5f6);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            color: #64b5f6;
            border-bottom-color: #64b5f6;
            background: white;
        }

        .nav-tab:hover {
            color: #64b5f6;
            background: rgba(100, 181, 246, 0.05);
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        label {
            font-weight: 500;
            color: #374151;
        }

        input, select, textarea {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #64b5f6;
            box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #64b5f6, #64b5f6);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(100, 181, 246, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-passkey {
            background: linear-gradient(135deg, #4caf50, #4caf50);
            color: white;
            margin-top: 10px;
        }

        .btn-passkey:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .data-table th {
            background: #f8fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #f3f4f6;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-disabled {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-locked {
            background: #fef3c7;
            color: #92400e;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .close-modal:hover {
            color: #374151;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #64b5f6, #64b5f6);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .password-strength {
            margin-top: 5px;
            font-size: 12px;
            color: #6b7280;
        }

        .strength-weak { color: #ef4444; }
        .strength-medium { color: #90a4ae; }
        .strength-strong { color: #10b981; }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
            }

            .data-table {
                font-size: 14px;
            }

            .data-table th,
            .data-table td {
                padding: 10px;
            }
        }

        async function deleteRole(roleId, roleName) {
            if (!confirm(`Are you sure you want to delete role "${roleName}"? This will also unassign it from all users.`)) {
                return;
            }
            
            try {
                const response = await apiRequest(`/roles/${roleId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('rolesAlert', 'Role deleted successfully', 'success');
                    loadRoles();
                    loadUsers(); // Users roles might have changed
                    loadAuditLogs();
                } else {
                    showAlert('rolesAlert', result.detail || 'Failed to delete role', 'error');
                }
            } catch (error) {
                showAlert('rolesAlert', 'Network error', 'error');
            }
        }

        async function deleteGroup(groupId, groupName) {
            if (!confirm(`Are you sure you want to delete group "${groupName}"? This will also unassign it from all users.`)) {
                return;
            }
            
            try {
                const response = await apiRequest(`/groups/${groupId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('groupsAlert', 'Group deleted successfully', 'success');
                    loadGroups();
                    loadUsers(); // Users groups might have changed
                    loadAuditLogs();
                } else {
                    showAlert('groupsAlert', result.detail || 'Failed to delete group', 'error');
                }
            } catch (error) {
                showAlert('groupsAlert', 'Network error', 'error');
            }
        }

        /* NEW CSS FOR GROUP MEMBERSHIP MODAL */
        .member-management-section {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .member-management-section > div {
            flex: 1;
            min-width: 280px;
            background: #f8fafc; /* Light background for lists */
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e2e8f0; /* Light border */
        }

        .member-management-section h4 {
            margin-top: 0;
            color: #374151; /* Darker text for titles */
            font-size: 1em;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }

        .user-selection-list {
            list-style: none;
            padding: 0;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #cbd5e1; /* Slightly darker border for the list itself */
            border-radius: 5px;
            background: #ffffff; /* White background for list items */
        }

        .user-selection-list li {
            padding: 8px 12px;
            border-bottom: 1px solid #f3f4f6; /* Lighter border for list items */
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-selection-list li:last-child {
            border-bottom: none;
        }

        .user-selection-list li:hover {
            background-color: #e2e8f0; /* Light hover effect */
        }

        .user-selection-list li button {
            background: none;
            border: 1px solid #64b5f6; /* Primary button color */
            color: #64b5f6;
            cursor: pointer;
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 5px;
            transition: all 0.2s ease;
        }

        .user-selection-list li button.remove-btn {
            border: 1px solid #ef4444; /* Danger button color */
            color: #ef4444;
        }

        .user-selection-list li button:hover {
            background-color: #64b5f6;
            color: white;
        }

        .user-selection-list li button.remove-btn:hover {
            background-color: #ef4444;
            color: white;
        }
        /* END NEW CSS */
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1 style="margin-bottom: 30px; color: #64b5f6;">üõ°Ô∏è Admin Portal</h1>
            
            <div id="loginAlert" class="alert"></div>
            
            <form id="loginForm" class="form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>
            
            <button id="passkeyLogin" class="btn btn-passkey">
                üîê Sign in with Passkey
            </button>
            
            <div id="loginLoading" class="loading">
                <div class="spinner"></div>
                <p>Signing in...</p>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel">
        <div class="header">
            <h1>üõ°Ô∏è Admin Portal</h1>
            <div class="user-info">
                <span id="currentUser">Loading...</span>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>
        </div>
        <div id="debugTokenInfo" style="background: #fff3e0; color: #e65100; padding: 5px 20px; font-size: 12px; border-bottom: 1px solid #ffcc80; display: none;">
            Debug: Token Status: <span id="tokenStatus">N/A</span>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
            <button class="nav-tab" data-tab="users">Users</button>
            <button class="nav-tab" data-tab="roles">Roles</button>
            <button class="nav-tab" data-tab="groups">Groups</button>
            <button class="nav-tab" data-tab="audit">Audit Logs</button>
            <button class="nav-tab" data-tab="settings">Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">-</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRoles">-</div>
                    <div class="stat-label">Roles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recentLogins">-</div>
                    <div class="stat-label">Recent Logins</div>
                </div>
            </div>

            <div class="card">
                <h3>Recent Activity</h3>
                <div id="recentActivity">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>User Management</h3>
                    <button id="createUserBtn" class="btn btn-primary">Create User</button>
                </div>
                
                <div id="usersAlert" class="alert"></div>
                
                <table id="usersTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Status</th>
                            <th>Roles</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Roles Tab -->
        <div id="roles" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Role Management</h3>
                    <button id="createRoleBtn" class="btn btn-primary">Create Role</button>
                </div>
                
                <div id="rolesAlert" class="alert"></div>
                
                <table id="rolesTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Role Name</th>
                            <th>Description</th>
                            <th>Permissions</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Groups Tab -->
        <div id="groups" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Group Management</h3>
                    <button id="createGroupBtn" class="btn btn-primary">Create Group</button>
                </div>
                
                <div id="groupsAlert" class="alert"></div>
                
                <table id="groupsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Group Name</th>
                            <th>Description</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Audit Logs Tab -->
        <div id="audit" class="tab-content">
            <div class="card">
                <h3>Audit Logs</h3>

                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="eventTypeFilter">Event Type</label>
                        <select id="eventTypeFilter">
                            <option value="">All Events</option>
                            <option value="LOGIN_SUCCESS">Login Success</option>
                            <option value="LOGIN_FAILED">Login Failed</option>
                            <option value="USER_CREATED">User Created</option>
                            <option value="USER_UPDATED">User Updated</option>
                            <option value="ROLE_ASSIGNED">Role Assigned</option>
                            <option value="GROUP_CREATED">Group Created</option>
                            <option value="GROUP_UPDATED">Group Updated</option>
                            <option value="GROUP_DELETED">Group Deleted</option>
                            <option value="GROUP_ASSIGNED">Group Assigned</option>
                            <option value="GROUP_MEMBERSHIP_REMOVED">Group Membership Removed</option>
                            <option value="PASSKEY_REGISTERED">Passkey Registered</option>
                            <option value="PASSKEY_DELETED">Passkey Deleted</option>
                            <option value="PASSWORD_CHANGED">Password Changed</option>
                            <option value="ACCOUNT_LOCKED">Account Locked</option>
                            <option value="LOGIN_BLOCKED">Login Blocked</option>
                            <option value="EMERGENCY_ACCESS_GRANTED">Emergency Access Granted</option>
                            <option value="EMERGENCY_ACCESS_DENIED">Emergency Access Denied</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userFilter">User</label>
                        <select id="userFilter">
                            <option value="">All Users</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ipAddressFilter">IP Address</label>
                        <input type="text" id="ipAddressFilter" placeholder="e.g., 192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label for="descriptionFilter">Description Keyword</label>
                        <input type="text" id="descriptionFilter" placeholder="e.g., created user">
                    </div>
                    <div class="form-group" style="align-self: end;">
                        <button id="filterAuditBtn" class="btn btn-primary">Filter</button>
                    </div>
                </div>

                <table id="auditTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Event Type</th>
                            <th>Description</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h3>Account Settings</h3>
                
                <div id="settingsAlert" class="alert"></div>
                
                <form id="changePasswordForm" class="form">
                    <h4 style="margin-bottom: 15px;">Change Password</h4>
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" name="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="newPassword" required>
                        <div id="passwordStrength" class="password-strength"></div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </form>

                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e5e7eb;">

                <div>
                    <h4 style="margin-bottom: 15px;">Passkey Management</h4>
                    <p style="margin-bottom: 15px; color: #6b7280;">Register a passkey for secure, passwordless authentication.</p>
                    <div id="passkeySection">
                        <button id="registerPasskeyBtn" class="btn btn-passkey">Register Passkey</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Create User</h3>
                <button class="close-modal">&times;</button>
            </div>

            <div id="userModalAlert" class="alert"></div>

            <form id="userForm" class="form">
                <div class="form-group">
                    <label for="modalUsername">Username</label>
                    <input type="text" id="modalUsername" name="username" required>
                </div>
                <div class="form-group" id="passwordGroup">
                    <label for="modalPassword">Password</label>
                    <input type="password" id="modalPassword" name="password">
                    <div id="modalPasswordStrength" class="password-strength"></div>
                </div>
                <div class="form-group">
                    <label for="modalAccountStatus">Account Status</label>
                    <select id="modalAccountStatus" name="account_status">
                        <option value="Active">Active</option>
                        <option value="Disabled">Disabled</option>
                        <option value="Locked">Locked</option>
                    </select>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Role Modal -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="roleModalTitle">Create Role</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div id="roleModalAlert" class="alert"></div>
            
            <form id="roleForm" class="form">
                <div class="form-group">
                    <label for="modalRoleName">Role Name</label>
                    <input type="text" id="modalRoleName" name="role_name" required>
                </div>
                <div class="form-group">
                    <label for="modalRoleDescription">Description</label>
                    <textarea id="modalRoleDescription" name="description" rows="3"></textarea>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="groupModalTitle">Create Group</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div id="groupModalAlert" class="alert"></div>
            
            <form id="groupForm" class="form">
                <div class="form-group">
                    <label for="modalGroupName">Group Name</label>
                    <input type="text" id="modalGroupName" name="group_name" required>
                </div>
                <div class="form-group">
                    <label for="modalGroupDescription">Description</label>
                    <textarea id="modalGroupDescription" name="description" rows="3"></textarea>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Permission Modal -->
    <div id="permissionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="permissionModalTitle">Manage Permissions for Role: <span id="permissionRoleName"></span></h3>
                <button class="close-modal">&times;</button>
            </div>

            <div id="permissionModalAlert" class="alert"></div>

            <div id="permissionsList" class="form-group" style="max-height: 400px; overflow-y: auto;">
                <!-- Permissions will be loaded here -->
            </div>

            <div class="action-buttons">
                <button type="button" class="btn btn-secondary close-modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Group Membership Modal -->
    <div id="groupMembershipModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="groupMembershipModalTitle">Manage Members for Group: <span id="groupMembershipGroupName"></span></h3>
                <button class="close-modal">&times;</button>
            </div>

            <div id="groupMembershipModalAlert" class="alert"></div>

            <div class="member-management-section">
                <div class="available-users-list">
                    <h4>Available Users</h4>
                    <ul id="availableUsersForGroup" class="user-selection-list"></ul>
                </div>
                <div class="group-members-list">
                    <h4>Group Members</h4>
                    <ul id="currentGroupMembers" class="user-selection-list"></ul>
                </div>
            </div>

            <div class="action-buttons">
                <button type="button" class="btn btn-secondary close-modal">Close</button>
            </div>
        </div>
    </div>


    <script>
        // Global variables
        let currentToken = localStorage.getItem('adminToken');
        let currentUserData = null;
        let allPermissions = []; // To store all available permissions
        let allUsers = []; // To store all available users for group membership management
        const API_BASE = 'http://localhost:8000';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (currentToken) {
                showAdminPanel();
            } else {
                showLoginScreen();
            }
            
            initializeEventListeners();
        });

        // Event listeners
        function initializeEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('passkeyLogin').addEventListener('click', handlePasskeyLogin);
            
            // Navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Modal controls
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', closeModals);
            });
            
            // Create buttons
            document.getElementById('createUserBtn').addEventListener('click', () => openUserModal());
            document.getElementById('createRoleBtn').addEventListener('click', () => openRoleModal());
            document.getElementById('createGroupBtn').addEventListener('click', () => openGroupModal());
            
            // Forms
            document.getElementById('userForm').addEventListener('submit', handleUserForm);
            document.getElementById('roleForm').addEventListener('submit', handleRoleForm);
            document.getElementById('groupForm').addEventListener('submit', handleGroupForm);
            document.getElementById('changePasswordForm').addEventListener('submit', handlePasswordChange);
            
            // Password strength checker
            document.getElementById('newPassword').addEventListener('input', checkPasswordStrength);
            document.getElementById('modalPassword').addEventListener('input', checkModalPasswordStrength);

            // Passkey registration & management
            document.getElementById('registerPasskeyBtn').addEventListener('click', handlePasskeyRegistration);
            // Delete passkey button will be dynamically added, listener added below

            // Audit filtering
            document.getElementById('filterAuditBtn').addEventListener('click', loadAuditLogs);

            // Load all permissions and users once for respective modals
            loadAllPermissions();
            loadAllUsersForMembership();
            populateAuditEventTypes(); // Call to populate audit event types
        }

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            showLoading('loginLoading', true);
            
            try {
                const response = await fetch(`${API_BASE}/login/password`, {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.access_token;
                    localStorage.setItem('adminToken', currentToken);
                    updateDebugTokenInfo(); // Update debug info after successful login
                    showAdminPanel();
                } else {
                    const errorData = await response.json(); // Try to parse error as JSON
                    showAlert('loginAlert', errorData.detail || 'Login failed', 'error');
                    console.error('Login failed response:', response.status, errorData);
                    updateDebugTokenInfo(); // Update debug info on login failure
                }
            } catch (error) {
                console.error('Network or parsing error during login:', error);
                showAlert('loginAlert', 'Network error. Please try again. Check console for details.', 'error');
                updateDebugTokenInfo(); // Update debug info on network error
            } finally {
                showLoading('loginLoading', false);
            }
        }

        async function handlePasskeyLogin() {
            if (!navigator.credentials || !window.PublicKeyCredential) {
                showAlert('loginAlert', 'Passkeys are not supported in this browser', 'error');
                return;
            }
            
            const username = document.getElementById('username').value;
            if (!username) {
                showAlert('loginAlert', 'Please enter your username first', 'error');
                return;
            }
            
            showLoading('loginLoading', true);
            
            try {
                // Start passkey authentication
                const startResponse = await fetch(`${API_BASE}/passkey/authenticate/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const startData = await startResponse.json();
                
                if (!startResponse.ok) {
                    throw new Error(startData.detail || 'Failed to start passkey authentication');
                }
                
                // Get credential from browser
                const publicKeyCredential = await navigator.credentials.get({
                    publicKey: startData.publicKey
                });
                
                // Complete authentication
                const completeResponse = await fetch(`${API_BASE}/passkey/authenticate/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        assertion_response: {
                            clientDataJSON: Array.from(new Uint8Array(publicKeyCredential.response.clientDataJSON)),
                            authenticatorData: Array.from(new Uint8Array(publicKeyCredential.response.authenticatorData)),
                            signature: Array.from(new Uint8Array(publicKeyCredential.response.signature)),
                            state: startData.state
                        }
                    })
                });
                
                const completeData = await completeResponse.json();
                
                if (completeResponse.ok) {
                    currentToken = completeData.access_token;
                    localStorage.setItem('adminToken', currentToken);
                    showAdminPanel();
                } else {
                    throw new Error(completeData.detail || 'Passkey authentication failed');
                }
            } catch (error) {
                showAlert('loginAlert', error.message || 'Passkey authentication failed', 'error');
            } finally {
                showLoading('loginLoading', false);
            }
        }

        function handleLogout() {
            currentToken = null;
            currentUserData = null;
            localStorage.removeItem('adminToken');
            updateDebugTokenInfo(); // Update debug info on logout
            showLoginScreen();
        }

        // UI functions
        function updateDebugTokenInfo() {
            const tokenStatusElement = document.getElementById('tokenStatus');
            if (currentToken) {
                tokenStatusElement.textContent = `Present (Length: ${currentToken.length}, First 10: ${currentToken.substring(0, 10)}...)`;
                tokenStatusElement.style.color = '#2e7d32'; // Green for present
            } else {
                tokenStatusElement.textContent = 'Not Present';
                tokenStatusElement.style.color = '#d32f2f'; // Red for not present
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('debugTokenInfo').style.display = 'none'; // Hide debug info on login screen
        }

        function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('debugTokenInfo').style.display = 'block'; // Show debug info on admin panel
            updateDebugTokenInfo(); // Update debug info when showing admin panel
            loadCurrentUser();
            loadDashboardData();
        }

        function switchTab(tabName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Load data for specific tabs
            switch(tabName) {
                case 'users':
                    loadUsers();
                    break;
                case 'roles':
                    loadRoles();
                    break;
                case 'groups':
                    loadGroups();
                    break;
                case 'audit':
                    loadAuditLogs();
                    loadAuditFilters();
                    break;
            }
        }

        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function showLoading(elementId, show) {
            document.getElementById(elementId).style.display = show ? 'block' : 'none';
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // API functions
        async function apiRequest(endpoint, options = {}) {
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };
            
            if (currentToken) {
                config.headers.Authorization = `Bearer ${currentToken}`;
            }
            
            const response = await fetch(`${API_BASE}${endpoint}`, config);
            
            if (response.status === 401) {
                handleLogout();
                throw new Error('Session expired');
            }
            
            return response;
        }

        // Data loading functions
        async function loadCurrentUser() {
            try {
                const response = await apiRequest('/me');
                const userData = await response.json();
                
                if (response.ok) {
                    currentUserData = userData;
                    document.getElementById('currentUser').textContent = userData.username;
                    displayUserPasskeyStatus(currentUserData); // Display passkey status
                }
            } catch (error) {
                console.error('Failed to load current user:', error);
                showAlert('settingsAlert', 'Failed to load user data.', 'error');
            }
        }

        async function loadDashboardData() {
            try {
                // Load users for stats
                const usersResponse = await apiRequest('/users');
                if (usersResponse.ok) {
                    const users = await usersResponse.json();
                    document.getElementById('totalUsers').textContent = users.length;
                    document.getElementById('activeUsers').textContent = 
                        users.filter(u => u.account_status === 'Active').length;
                }
                
                // Load roles for stats
                const rolesResponse = await apiRequest('/roles');
                if (rolesResponse.ok) {
                    const roles = await rolesResponse.json();
                    document.getElementById('totalRoles').textContent = roles.length;
                }
                
                // Load recent audit logs
                const auditResponse = await apiRequest('/audit-logs?limit=10');
                if (auditResponse.ok) {
                    const logs = await auditResponse.json();
                    const recentLogins = logs.filter(log => 
                        log.event_type === 'LOGIN_SUCCESS' && 
                        Date.now() - (log.timestamp * 1000) < 24 * 60 * 60 * 1000
                    ).length;
                    document.getElementById('recentLogins').textContent = recentLogins;
                    
                    // Display recent activity
                    const activityHtml = logs.slice(0, 5).map(log => `
                        <div style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <strong>${log.event_type}</strong> - ${log.username || 'System'}
                            <br><small style="color: #6b7280;">${new Date(log.timestamp * 1000).toLocaleString()}</small>
                            <br><span style="font-size: 14px;">${log.event_description}</span>
                        </div>
                    `).join('');
                    document.getElementById('recentActivity').innerHTML = activityHtml;
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await apiRequest('/users');
                const users = await response.json();
                
                if (response.ok) {
                    const tbody = document.querySelector('#usersTable tbody');
                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.username}</td>
                            <td><span class="status-badge status-${user.account_status.toLowerCase()}">${user.account_status}</span></td>
                            <td>${user.roles.join(', ') || 'None'}</td>
                            <td>${user.last_login_at ? new Date(user.last_login_at * 1000).toLocaleString() : 'Never'}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editUser(${user.user_id})">Edit</button>
                                <button class="btn btn-danger" onclick="deleteUser(${user.user_id}, '${user.username}')">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    showAlert('usersAlert', 'Failed to load users', 'error');
                }
            } catch (error) {
                showAlert('usersAlert', 'Network error loading users', 'error');
            }
        }

        async function loadRoles() {
            try {
                const response = await apiRequest('/roles');
                const roles = await response.json();
                
                if (response.ok) {
                    const tbody = document.querySelector('#rolesTable tbody');
                    tbody.innerHTML = roles.map(role => `
                        <tr>
                            <td>${role.role_name}</td>
                            <td>${role.description || 'No description'}</td>
                            <td>${role.permissions.join(', ') || 'None'}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="openRoleModal(${role.role_id})">Edit</button>
                                <button class="btn btn-secondary" onclick="openPermissionModal(${role.role_id}, '${role.role_name}')">Permissions</button>
                                <button class="btn btn-danger" onclick="deleteRole(${role.role_id}, '${role.role_name}')">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    showAlert('rolesAlert', 'Failed to load roles', 'error');
                }
            } catch (error) {
                showAlert('rolesAlert', 'Network error loading roles', 'error');
            }
        }

        async function loadGroups() {
            try {
                const response = await apiRequest('/groups');
                const groups = await response.json();
                
                if (response.ok) {
                    const tbody = document.querySelector('#groupsTable tbody');
                    tbody.innerHTML = groups.map(group => `
                        <tr>
                            <td>${group.group_name}</td>
                            <td>${group.description || 'No description'}</td>
                            <td>${new Date(group.created_at * 1000).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="openGroupModal(${group.group_id})">Edit</button>
                                <button class="btn btn-secondary" onclick="openGroupMembershipModal(${group.group_id}, '${group.group_name}')">Members</button>
                                <button class="btn btn-danger" onclick="deleteGroup(${group.group_id}, '${group.group_name}')">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    showAlert('groupsAlert', 'Failed to load groups', 'error');
                }
            } catch (error) {
                showAlert('groupsAlert', 'Network error loading groups', 'error');
            }
        }

        async function loadAuditLogs() {
            try {
                const eventType = document.getElementById('eventTypeFilter').value;
                const userId = document.getElementById('userFilter').value;
                const ipAddress = document.getElementById('ipAddressFilter').value;
                const descriptionKeyword = document.getElementById('descriptionFilter').value;

                let url = new URL(`${API_BASE}/audit-logs`);
                url.searchParams.append('limit', '100'); // Increased limit for more logs

                if (eventType) url.searchParams.append('event_type', eventType);
                if (userId) url.searchParams.append('user_id', userId);
                if (ipAddress) url.searchParams.append('ip_address', ipAddress);
                if (descriptionKeyword) url.searchParams.append('description_keyword', descriptionKeyword);

                const response = await apiRequest(url.pathname + url.search); // Use pathname + search to send URL correctly
                const logs = await response.json();

                if (response.ok) {
                    const tbody = document.querySelector('#auditTable tbody');
                    tbody.innerHTML = logs.map(log => `
                        <tr>
                            <td>${new Date(log.timestamp * 1000).toLocaleString()}</td>
                            <td>${log.username || 'System'}</td>
                            <td><span class="status-badge" style="background: #e0f2fe; color: #0277bd;">${log.event_type}</span></td>
                            <td>${log.event_description}</td>
                            <td>${log.ip_address || 'N/A'}</td>
                        </tr>
                    `).join('');
                } else {
                    showAlert('auditAlert', 'Failed to load audit logs: ' + (logs.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('auditAlert', 'Network error loading audit logs', 'error');
                console.error('Failed to load audit logs:', error);
            }
        }

        async function loadAuditFilters() {
            try {
                const response = await apiRequest('/users');
                const users = await response.json();
                
                if (response.ok) {
                    const userFilter = document.getElementById('userFilter');
                    userFilter.innerHTML = '<option value="">All Users</option>' +
                        users.map(user => `<option value="${user.user_id}">${user.username}</option>`).join('');
                }
            } catch (error) {
                console.error('Failed to load audit filters:', error);
            }
        }

        async function populateAuditEventTypes() {
            // This would ideally come from an API endpoint, but for simplicity, use known types from backend
            const eventTypes = [
                "LOGIN_SUCCESS", "LOGIN_FAILED", "USER_CREATED", "USER_UPDATED",
                "USER_DISABLED", "USER_DELETED", "PASSWORD_CHANGED", "ACCOUNT_LOCKED",
                "ROLE_CREATED", "ROLE_UPDATED", "ROLE_DELETED", "PERMISSION_ASSIGNED",
                "PERMISSION_REMOVED", "ROLE_ASSIGNED_TO_USER", "ROLE_REMOVED_FROM_USER",
                "GROUP_CREATED", "GROUP_UPDATED", "GROUP_DELETED", "USER_ASSIGNED_TO_GROUP",
                "USER_REMOVED_FROM_GROUP", "PASSKEY_REGISTER_START", "PASSKEY_REGISTER_COMPLETE",
                "PASSKEY_AUTH_START", "PASSKEY_AUTH_COMPLETE", "PASSKEY_DELETED",
                "EMERGENCY_ACCESS_GRANTED", "EMERGENCY_ACCESS_DENIED"
            ];
            const select = document.getElementById('eventTypeFilter');
            // Clear existing options, except "All Events"
            select.querySelectorAll('option:not([value=""])').forEach(option => option.remove());
            eventTypes.sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
        }

        // Modal functions
        function openUserModal(userId = null) {
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const form = document.getElementById('userForm');
            
            if (userId) {
                title.textContent = 'Edit User';
                loadUserForEdit(userId);
            } else {
                title.textContent = 'Create User';
                form.reset();
                document.getElementById('passwordGroup').style.display = 'block';
                document.getElementById('modalPassword').required = true;
            }
            
            modal.style.display = 'flex';
        }

        function openRoleModal(roleId = null) {
            const modal = document.getElementById('roleModal');
            const title = document.getElementById('roleModalTitle');
            const form = document.getElementById('roleForm');
            
            if (roleId) {
                title.textContent = 'Edit Role';
                form.dataset.roleId = roleId; // Store role ID for update
                loadRoleForEdit(roleId);
            } else {
                title.textContent = 'Create Role';
                form.reset();
                delete form.dataset.roleId; // Clear role ID for new creation
            }
            
            modal.style.display = 'flex';
        }

        function openPermissionModal(roleId, roleName) {
            const modal = document.getElementById('permissionModal');
            document.getElementById('permissionRoleName').textContent = roleName;
            modal.dataset.roleId = roleId; // Store the roleId in the modal element
            loadRolePermissions(roleId);
            modal.style.display = 'flex';
        }

        function openGroupModal(groupId = null) {
            const modal = document.getElementById('groupModal');
            const title = document.getElementById('groupModalTitle');
            const form = document.getElementById('groupForm');
            
            if (groupId) {
                title.textContent = 'Edit Group';
                form.dataset.groupId = groupId; // Store group ID for update
                loadGroupForEdit(groupId);
            } else {
                title.textContent = 'Create Group';
                form.reset();
                delete form.dataset.groupId; // Clear group ID for new creation
            }
            
            modal.style.display = 'flex';
        }

        async function openGroupMembershipModal(groupId, groupName) {
            const modal = document.getElementById('groupMembershipModal');
            document.getElementById('groupMembershipGroupName').textContent = groupName;
            modal.dataset.groupId = groupId; // Store the groupId in the modal element
            loadGroupMembers(groupId);
            modal.style.display = 'flex';
        }

        // Form handlers
        async function handleUserForm(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = {
                username: formData.get('username'),
                account_status: formData.get('account_status')
            };
            
            if (formData.get('password')) {
                userData.password = formData.get('password');
            }
            
            try {
                const isEdit = e.target.dataset.userId;
                const endpoint = isEdit ? `/users/${isEdit}` : '/register';
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await apiRequest(endpoint, {
                    method,
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('userModalAlert', 'User saved successfully', 'success');
                    setTimeout(() => {
                        closeModals();
                        loadUsers();
                        loadAuditLogs(); // Refresh audit logs as user creation/update is logged
                    }, 1000);
                } else {
                    showAlert('userModalAlert', result.detail || 'Failed to save user', 'error');
                }
            } catch (error) {
                showAlert('userModalAlert', 'Network error', 'error');
            }
        }

        async function handleRoleForm(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const roleData = {
                role_name: formData.get('role_name'),
                description: formData.get('description')
            };
            
            try {
                const isEdit = e.target.dataset.roleId;
                const endpoint = isEdit ? `/roles/${isEdit}` : '/roles';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await apiRequest(endpoint, {
                    method,
                    body: JSON.stringify(roleData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('roleModalAlert', `Role ${isEdit ? 'updated' : 'created'} successfully`, 'success');
                    setTimeout(() => {
                        closeModals();
                        loadRoles();
                        loadAuditLogs(); // Refresh audit logs as role creation/update is logged
                    }, 1000);
                } else {
                    showAlert('roleModalAlert', result.detail || `Failed to ${isEdit ? 'update' : 'create'} role`, 'error');
                }
            } catch (error) {
                showAlert('roleModalAlert', 'Network error', 'error');
            }
        }

        async function handleGroupForm(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const groupData = {
                group_name: formData.get('group_name'),
                description: formData.get('description')
            };
            
            try {
                const isEdit = e.target.dataset.groupId;
                const endpoint = isEdit ? `/groups/${isEdit}` : '/groups';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await apiRequest(endpoint, {
                    method,
                    body: JSON.stringify(groupData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('groupModalAlert', `Group ${isEdit ? 'updated' : 'created'} successfully`, 'success');
                    setTimeout(() => {
                        closeModals();
                        loadGroups();
                        loadAuditLogs(); // Refresh audit logs as group creation/update is logged
                    }, 1000);
                } else {
                    showAlert('groupModalAlert', result.detail || `Failed to ${isEdit ? 'update' : 'create'} group`, 'error');
                }
            } catch (error) {
                showAlert('groupModalAlert', 'Network error', 'error');
            }
        }

        async function handlePasswordChange(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            if (formData.get('newPassword') !== formData.get('confirmPassword')) {
                showAlert('settingsAlert', 'New passwords do not match', 'error');
                return;
            }
            
            const passwordData = {
                old_password: formData.get('currentPassword'),
                new_password: formData.get('newPassword')
            };
            
            try {
                const response = await apiRequest('/change-password', {
                    method: 'POST',
                    body: JSON.stringify(passwordData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('settingsAlert', 'Password changed successfully', 'success');
                    e.target.reset();
                    loadAuditLogs(); // Refresh audit logs as password change is logged
                } else {
                    showAlert('settingsAlert', result.detail || 'Failed to change password', 'error');
                }
            } catch (error) {
                showAlert('settingsAlert', 'Network error', 'error');
            }
        }

        // User management functions
        async function editUser(userId) {
            openUserModal(userId);
        }

        async function loadUserForEdit(userId) {
            try {
                const response = await apiRequest(`/users/${userId}`);
                const user = await response.json();
                
                if (response.ok) {
                    document.getElementById('modalUsername').value = user.username;
                    document.getElementById('modalAccountStatus').value = user.account_status;
                    document.getElementById('passwordGroup').style.display = 'none';
                    document.getElementById('modalPassword').required = false;
                    document.getElementById('userForm').dataset.userId = userId;
                }
            } catch (error) {
                showAlert('userModalAlert', 'Failed to load user data', 'error');
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
                return;
            }
            
            try {
                const response = await apiRequest(`/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('usersAlert', 'User deleted successfully', 'success');
                    loadUsers();
                } else {
                    showAlert('usersAlert', result.detail || 'Failed to delete user', 'error');
                }
            } catch (error) {
                showAlert('usersAlert', 'Network error', 'error');
            }
        }

        // Passkey functions
        async function handlePasskeyRegistration() {
            if (!navigator.credentials || !window.PublicKeyCredential) {
                showAlert('settingsAlert', 'Passkeys are not supported in this browser', 'error');
                return;
            }
            
            try {
                // Start passkey registration
                const startResponse = await apiRequest('/passkey/register/start', {
                    method: 'POST',
                    body: JSON.stringify({ username: currentUserData.username })
                });
                
                const startData = await startResponse.json();
                
                if (!startResponse.ok) {
                    throw new Error(startData.detail || 'Failed to start passkey registration');
                }
                
                // Create credential
                const publicKeyCredential = await navigator.credentials.create({
                    publicKey: startData.publicKey
                });
                
                // Complete registration
                const completeResponse = await apiRequest('/passkey/register/complete', {
                    method: 'POST',
                    body: JSON.stringify({
                        username: currentUserData.username,
                        attestation_response: {
                            clientDataJSON: Array.from(new Uint8Array(publicKeyCredential.response.clientDataJSON)),
                            attestationObject: Array.from(new Uint8Array(publicKeyCredential.response.attestationObject)),
                            state: startData.state
                        }
                    })
                });
                
                const completeData = await completeResponse.json();
                
                if (completeResponse.ok) {
                    showAlert('settingsAlert', 'Passkey registered successfully', 'success');
                    loadCurrentUser(); // Refresh user data to show new passkey status
                    loadAuditLogs(); // Log passkey registration
                } else {
                    throw new Error(completeData.detail || 'Passkey registration failed');
                }
            } catch (error) {
                showAlert('settingsAlert', error.message || 'Passkey registration failed', 'error');
            }
        }

        async function handleDeletePasskey() {
            if (!confirm('Are you sure you want to delete your registered passkey? You will need to use your password or register a new passkey to log in.')) {
                return;
            }

            try {
                const response = await apiRequest('/me/passkeys', {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('settingsAlert', 'Passkey deleted successfully', 'success');
                    loadCurrentUser(); // Refresh user data to show no passkey
                    loadAuditLogs(); // Log passkey deletion
                } else {
                    showAlert('settingsAlert', result.detail || 'Failed to delete passkey', 'error');
                }
            } catch (error) {
                showAlert('settingsAlert', error.message || 'Network error deleting passkey', 'error');
            }
        }

        function displayUserPasskeyStatus(user) {
            const passkeySection = document.getElementById('passkeySection');
            passkeySection.innerHTML = ''; // Clear existing content

            if (user.passkey_credential_id) {
                passkeySection.innerHTML = `
                    <p style="margin-bottom: 10px; color: #6b7280;">You have a passkey registered. Credential ID: <code>${user.passkey_credential_id.substring(0, 10)}...</code></p>
                    <button id="deletePasskeyBtn" class="btn btn-danger">Delete Passkey</button>
                `;
                document.getElementById('deletePasskeyBtn').addEventListener('click', handleDeletePasskey);
            } else {
                passkeySection.innerHTML = `
                    <p style="margin-bottom: 15px; color: #6b7280;">Register a passkey for secure, passwordless authentication.</p>
                    <button id="registerPasskeyBtn" class="btn btn-passkey">Register Passkey</button>
                `;
                document.getElementById('registerPasskeyBtn').addEventListener('click', handlePasskeyRegistration);
            }
        }

        // Group Membership Management functions
        async function loadAllUsersForMembership() {
            try {
                const response = await apiRequest('/users');
                if (response.ok) {
                    allUsers = await response.json();
                } else {
                    console.error('Failed to load all users for membership:', await response.json());
                }
            } catch (error) {
                console.error('Network error loading all users for membership:', error);
            }
        }

        let currentManagingGroupId = null; // New global variable to store the ID of the group being managed

        async function openGroupMembershipModal(groupId, groupName) {
            currentManagingGroupId = groupId;
            document.getElementById('groupMembershipGroupName').textContent = groupName;
            document.getElementById('groupMembershipModal').style.display = 'flex';
            await loadGroupMembers(groupId);
            await loadAvailableUsersForGroup(groupId);
        }

        async function loadGroupMembers(groupId) {
            const currentGroupMembersList = document.getElementById('currentGroupMembers');
            currentGroupMembersList.innerHTML = '<div class="loading"><div class="spinner"></div></div>'; // Show loading

            try {
                const response = await apiRequest(`/groups/${groupId}/members`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const members = await response.json();
                renderGroupMembers(members);
            } catch (error) {
                console.error("Error fetching group members:", error);
                showAlert('groupMembershipModalAlert', `Error fetching group members: ${error.message}`, 'error');
                currentGroupMembersList.innerHTML = '<li class="no-items">Error loading members.</li>';
            }
        }

        function renderGroupMembers(members) {
            const currentGroupMembersList = document.getElementById('currentGroupMembers');
            currentGroupMembersList.innerHTML = '';
            if (members.length === 0) {
                currentGroupMembersList.innerHTML = '<li class="no-items">No members in this group.</li>';
                return;
            }
            members.forEach(member => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${member.username} (ID: ${member.user_id})</span>
                    <button class="remove-btn" onclick="removeUserFromGroup(${currentManagingGroupId}, ${member.user_id}, '${member.username}')">Remove</button>
                `;
                currentGroupMembersList.appendChild(li);
            });
        }

        async function loadAvailableUsersForGroup(groupId) {
            const availableUsersList = document.getElementById('availableUsersForGroup');
            availableUsersList.innerHTML = '<div class="loading"><div class="spinner"></div></div>'; // Show loading

            try {
                const allUsersResponse = await apiRequest('/users'); // Fetch all users
                if (!allUsersResponse.ok) throw new Error(`HTTP error! status: ${allUsersResponse.status}`);
                const allUsers = await allUsersResponse.json();

                const membersResponse = await apiRequest(`/groups/${groupId}/members`); // Get current group members
                if (!membersResponse.ok) throw new Error(`HTTP error! status: ${membersResponse.status}`);
                const currentMembers = await membersResponse.json();
                const currentMemberIds = new Set(currentMembers.map(m => m.user_id));

                const availableUsers = allUsers.filter(user => !currentMemberIds.has(user.user_id));
                renderAvailableUsersForGroup(availableUsers);

            } catch (error) {
                console.error("Error fetching available users for group:", error);
                showAlert('groupMembershipModalAlert', `Error fetching available users: ${error.message}`, 'error');
                availableUsersList.innerHTML = '<li class="no-items">Error loading available users.</li>';
            }
        }

        function renderAvailableUsersForGroup(users) {
            const availableUsersList = document.getElementById('availableUsersForGroup');
            availableUsersList.innerHTML = '';
            if (users.length === 0) {
                availableUsersList.innerHTML = '<li class="no-items">No more users to add.</li>';
                return;
            }
            users.forEach(user => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${user.username} (ID: ${user.user_id})</span>
                    <button onclick="assignUserToGroup(${currentManagingGroupId}, ${user.user_id}, '${user.username}')">Add</button>
                `;
                availableUsersList.appendChild(li);
            });
        }

        async function assignUserToGroup(groupId, userId, username) {
            try {
                const response = await apiRequest(`/users/${userId}/groups/${groupId}`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                showAlert('groupMembershipModalAlert', `User "${username}" assigned to group successfully!`, 'success');
                loadGroupMembers(groupId); // Refresh current members
                loadAvailableUsersForGroup(groupId); // Refresh available users
                loadGroups(); // Refresh main groups list
                loadAuditLogs(); // Log the event
            } catch (error) {
                console.error("Error assigning user to group:", error);
                showAlert('groupMembershipModalAlert', `Error assigning user to group: ${error.message}`, 'error');
            }
        }

        async function removeUserFromGroup(groupId, userId, username) {
            try {
                const response = await apiRequest(`/users/${userId}/groups/${groupId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                showAlert('groupMembershipModalAlert', `User "${username}" removed from group successfully!`, 'success');
                loadGroupMembers(groupId); // Refresh current members
                loadAvailableUsersForGroup(groupId); // Refresh available users
                loadGroups(); // Refresh main groups list
                loadAuditLogs(); // Log the event
            } catch (error) {
                console.error("Error removing user from group:", error);
                showAlert('groupMembershipModalAlert', `Error removing user from group: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthDiv = document.getElementById('passwordStrength');
            
            if (password.length === 0) {
                strengthDiv.textContent = '';
                return;
            }
            
            let score = 0;
            let feedback = [];
            
            if (password.length >= 8) score++;
            else feedback.push('at least 8 characters');
            
            if (/[a-z]/.test(password)) score++;
            else feedback.push('lowercase letter');
            
            if (/[A-Z]/.test(password)) score++;
            else feedback.push('uppercase letter');
            
            if (/\d/.test(password)) score++;
            else feedback.push('number');
            
            if (/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) score++;
            else feedback.push('special character');
            
            if (score < 3) {
                strengthDiv.className = 'password-strength strength-weak';
                strengthDiv.textContent = `Weak - Missing: ${feedback.join(', ')}`;
            } else if (score < 5) {
                strengthDiv.className = 'password-strength strength-medium';
                strengthDiv.textContent = `Medium - Missing: ${feedback.join(', ')}`;
            } else {
                strengthDiv.className = 'password-strength strength-strong';
                strengthDiv.textContent = 'Strong password';
            }
        }

        function checkModalPasswordStrength() {
            const password = document.getElementById('modalPassword').value;
            const strengthDiv = document.getElementById('modalPasswordStrength');
            
            if (password.length === 0) {
                strengthDiv.textContent = '';
                return;
            }
            
            let score = 0;
            let feedback = [];
            
            if (password.length >= 8) score++;
            else feedback.push('at least 8 characters');
            
            if (/[a-z]/.test(password)) score++;
            else feedback.push('lowercase letter');
            
            if (/[A-Z]/.test(password)) score++;
            else feedback.push('uppercase letter');
            
            if (/\d/.test(password)) score++;
            else feedback.push('number');
            
            if (/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) score++;
            else feedback.push('special character');
            
            if (score < 3) {
                strengthDiv.className = 'password-strength strength-weak';
                strengthDiv.textContent = `Weak - Missing: ${feedback.join(', ')}`;
            } else if (score < 5) {
                strengthDiv.className = 'password-strength strength-medium';
                strengthDiv.textContent = `Medium - Missing: ${feedback.join(', ')}`;
            } else {
                strengthDiv.className = 'password-strength strength-strong';
                strengthDiv.textContent = 'Strong password';
            }
        }

        // Data loading for modals
        async function loadRoleForEdit(roleId) {
            try {
                const response = await apiRequest(`/roles`); // Fetch all roles to find the one by ID easily
                const roles = await response.json();
                const role = roles.find(r => r.role_id === roleId);
                
                if (response.ok && role) {
                    document.getElementById('modalRoleName').value = role.role_name;
                    document.getElementById('modalRoleDescription').value = role.description || '';
                } else {
                    showAlert('roleModalAlert', 'Failed to load role data', 'error');
                }
            } catch (error) {
                showAlert('roleModalAlert', 'Network error loading role data', 'error');
            }
        }

        async function loadGroupForEdit(groupId) {
            try {
                const response = await apiRequest(`/groups`); // Fetch all groups
                const groups = await response.json();
                const group = groups.find(g => g.group_id === groupId);
                
                if (response.ok && group) {
                    document.getElementById('modalGroupName').value = group.group_name;
                    document.getElementById('modalGroupDescription').value = group.description || '';
                } else {
                    showAlert('groupModalAlert', 'Failed to load group data', 'error');
                }
            } catch (error) {
                showAlert('groupModalAlert', 'Network error loading group data', 'error');
            }
        }

        async function loadAllPermissions() {
            try {
                const response = await apiRequest('/permissions');
                if (response.ok) {
                    allPermissions = await response.json();
                } else {
                    console.error('Failed to load all permissions:', await response.json());
                }
            } catch (error) {
                console.error('Network error loading all permissions:', error);
            }
        }

        async function loadRolePermissions(roleId) {
            const permissionsListDiv = document.getElementById('permissionsList');
            permissionsListDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>'; // Show loading

            try {
                // Fetch the specific role's current permissions
                const rolesResponse = await apiRequest('/roles');
                const roles = await rolesResponse.json();
                const currentRole = roles.find(r => r.role_id === roleId);

                if (!rolesResponse.ok || !currentRole) {
                    showAlert('permissionModalAlert', 'Failed to load role permissions.', 'error');
                    permissionsListDiv.innerHTML = '<p>Error loading permissions.</p>';
                    return;
                }

                const rolePermissionsNames = currentRole.permissions;
                
                // Display checkboxes for all available permissions
                permissionsListDiv.innerHTML = allPermissions.map(perm => {
                    const isChecked = rolePermissionsNames.includes(perm.permission_name);
                    return `
                        <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm-${perm.permission_name}" value="${perm.permission_name}" ${isChecked ? 'checked' : ''} 
                                onchange="toggleRolePermission(${roleId}, '${perm.permission_name}', this.checked)">
                            <label for="perm-${perm.permission_name}">${perm.permission_name}</label>
                            <small style="color: #6b7280;">${perm.description || ''}</small>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                showAlert('permissionModalAlert', 'Network error loading permissions', 'error');
                permissionsListDiv.innerHTML = '<p>Network error loading permissions.</p>';
                console.error('Error loading role permissions:', error);
            }
        }

        async function toggleRolePermission(roleId, permissionName, isChecked) {
            try {
                const method = isChecked ? 'POST' : 'DELETE';
                const response = await apiRequest(`/roles/${roleId}/permissions/${permissionName}`, {
                    method
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('permissionModalAlert', `Permission ${permissionName} ${isChecked ? 'assigned' : 'removed'}`, 'success');
                    loadRoles(); // Refresh roles list to show updated permissions
                    loadAuditLogs(); // Log permission change
                } else {
                    showAlert('permissionModalAlert', result.detail || `Failed to ${isChecked ? 'assign' : 'remove'} permission`, 'error');
                    // Revert checkbox state if API call failed
                    document.getElementById(`perm-${permissionName}`).checked = !isChecked;
                }
            } catch (error) {
                showAlert('permissionModalAlert', 'Network error toggling permission', 'error');
                document.getElementById(`perm-${permissionName}`).checked = !isChecked; // Revert
            }
        }

        // Click outside modal to close
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModals();
            }
        });
    </script>
</body>
</html>
